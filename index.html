<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>E-Learning Quiz App</title>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  
  <script type="text/babel">
    const { useState } = React;
    
    // Icons
    const Brain = () => (
      <svg className="w-10 h-10 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
      </svg>
    );
    
    const BookOpen = () => (
      <svg className="w-6 h-6 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
      </svg>
    );
    
    const ChevronRight = () => (
      <svg className="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" />
      </svg>
    );
    
    const CheckCircle = () => (
      <svg className="w-6 h-6 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    
    const XCircle = () => (
      <svg className="w-6 h-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
    );
    
    const Loader2 = () => (
      <svg className="w-16 h-16 text-indigo-600 animate-spin mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
      </svg>
    );

    function ELearningApp() {
      const [step, setStep] = useState('input');
      const [studentData, setStudentData] = useState({
        learner_id: '',
        past_courses: '',
        quiz_scores: ''
      });
      const [results, setResults] = useState(null);
      const [currentQuizIndex, setCurrentQuizIndex] = useState(0);
      const [userAnswers, setUserAnswers] = useState({});
      const [quizSubmitted, setQuizSubmitted] = useState(false);
      const [allQuizScores, setAllQuizScores] = useState({});
      const [error, setError] = useState('');

      const N8N_WEBHOOK_URL = 'https://nihed.app.n8n.cloud/webhook/Recommendation';

      const handleInputChange = (e) => {
        setStudentData({
          ...studentData,
          [e.target.name]: e.target.value
        });
      };

      const handleSubmit = async () => {
        setError('');
        
        // Validate input before proceeding
        if (!studentData.learner_id || !studentData.past_courses || !studentData.quiz_scores) {
          setError('Please fill in all fields');
          return;
        }

        setStep('loading');

        try {
          const courses = studentData.past_courses.split(',').map(c => c.trim());
          const scores = studentData.quiz_scores.split(',').map(s => parseInt(s.trim()));

          if (courses.length !== scores.length) {
            throw new Error('Number of courses must match number of scores');
          }

          const response = await fetch(N8N_WEBHOOK_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify({
              learner_id: studentData.learner_id,
              past_courses: courses,
              quiz_scores: scores
            })
          });

          if (!response.ok) {
            throw new Error('Failed to get recommendations');
          }

          const data = await response.json();
          setResults(data);
          setStep('explanation');
        } catch (err) {
          setError(err.message);
          setStep('input');
        }
      };

      const handleAnswerSelect = (questionIndex, answer) => {
        const key = `${currentQuizIndex}-${questionIndex}`;
        setUserAnswers({
          ...userAnswers,
          [key]: answer
        });
      };

      const handleQuizSubmit = () => {
        setQuizSubmitted(true);
      };

      const calculateScore = () => {
        if (!results || !results.recommended_quizzes[currentQuizIndex]) return { correct: 0, total: 0 };
        
        const quiz = results.recommended_quizzes[currentQuizIndex];
        const questions = quiz.selected_quiz?.questions || [];
        
        let correct = 0;
        questions.forEach((q, idx) => {
          const key = `${currentQuizIndex}-${idx}`;
          if (userAnswers[key] === q.correct_answer) {
            correct++;
          }
        });
        
        return { correct, total: questions.length };
      };

      const goToNextQuiz = () => {
        // Save current quiz score
        const score = calculateScore();
        const quiz = results.recommended_quizzes[currentQuizIndex];
        setAllQuizScores({
          ...allQuizScores,
          [quiz.course_name]: score
        });

        // Check if this was the last quiz
        if (currentQuizIndex >= results.recommended_quizzes.length - 1) {
          setStep('summary');
        } else {
          setCurrentQuizIndex(currentQuizIndex + 1);
          setQuizSubmitted(false);
          setStep('explanation');
        }
      };

      const restartFlow = () => {
        setStep('input');
        setStudentData({ learner_id: '', past_courses: '', quiz_scores: '' });
        setResults(null);
        setCurrentQuizIndex(0);
        setUserAnswers({});
        setQuizSubmitted(false);
        setAllQuizScores({});
        setError('');
      };

      if (step === 'input') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="flex items-center gap-3 mb-6">
                  <Brain />
                  <h1 className="text-3xl font-bold text-gray-800">AI Learning Assistant</h1>
                </div>
                
                <p className="text-gray-600 mb-8">
                  Enter your information to get personalized quiz recommendations.
                </p>

                {error && (
                  <div className="bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6">
                    {error}
                  </div>
                )}

                <div className="space-y-6">
                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Student ID
                    </label>
                    <input
                      type="text"
                      name="learner_id"
                      value={studentData.learner_id}
                      onChange={handleInputChange}
                      placeholder="e.g., STU001"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Past Courses (comma-separated)
                    </label>
                    <input
                      type="text"
                      name="past_courses"
                      value={studentData.past_courses}
                      onChange={handleInputChange}
                      placeholder="e.g., SQL, Python, JavaScript"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-gray-700 mb-2">
                      Quiz Scores (comma-separated)
                    </label>
                    <input
                      type="text"
                      name="quiz_scores"
                      value={studentData.quiz_scores}
                      onChange={handleInputChange}
                      placeholder="e.g., 85, 70, 26"
                      className="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                    />
                  </div>

                  <button
                    onClick={handleSubmit}
                    disabled={!studentData.learner_id || !studentData.past_courses || !studentData.quiz_scores}
                    className="w-full bg-indigo-600 text-white py-4 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2 disabled:bg-gray-400 disabled:cursor-not-allowed"
                  >
                    Get Recommendations
                    <ChevronRight />
                  </button>
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (step === 'loading') {
        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 flex items-center justify-center">
            <div className="bg-white rounded-2xl shadow-xl p-12 text-center">
              <Loader2 />
              <h2 className="text-2xl font-bold text-gray-800 mb-2">Analyzing Your Profile...</h2>
              <p className="text-gray-600">Our AI is generating personalized recommendations</p>
            </div>
          </div>
        );
      }

      if (step === 'explanation' && results) {
        const quiz = results.recommended_quizzes[currentQuizIndex];
        const explanation = results.explanations?.find(
          e => e.course_name === quiz.course_name
        );

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="flex items-center justify-between mb-6">
                  <div className="flex items-center gap-3">
                    <BookOpen />
                    <h1 className="text-3xl font-bold text-gray-800">{quiz.course_name}</h1>
                  </div>
                  <span className="text-sm text-gray-600">
                    Quiz {currentQuizIndex + 1} of {results.recommended_quizzes.length}
                  </span>
                </div>

                {explanation && (
                  <div className="mb-8">
                    <div className="bg-indigo-50 border-l-4 border-indigo-600 p-6 rounded-lg mb-4">
                      <h2 className="font-semibold text-lg text-gray-800 mb-3">
                        ðŸ’¡ Why this quiz?
                      </h2>
                      <p className="text-gray-700 mb-4">{explanation.explanation}</p>
                      <div className="bg-white p-4 rounded-lg border border-indigo-200">
                        <p className="text-gray-600 text-sm">
                          <strong>Learning Tip:</strong> {explanation.learning_tip}
                        </p>
                      </div>
                    </div>
                  </div>
                )}

                {quiz.resources && (quiz.resources.websites?.length > 0 || quiz.resources.youtube_videos?.length > 0) && (
                  <div className="bg-amber-50 border-l-4 border-amber-500 p-6 rounded-lg mb-8">
                    <h3 className="font-semibold text-lg text-gray-800 mb-4">
                      ðŸ“š Recommended Resources
                    </h3>
                    
                    {quiz.resources.websites?.length > 0 && (
                      <div className="mb-4">
                        <p className="font-medium text-gray-700 mb-2">Websites:</p>
                        <ul className="space-y-2">
                          {quiz.resources.websites.map((url, i) => (
                            <li key={i}>
                              <a
                                href={url}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-indigo-600 hover:underline text-sm break-all"
                              >
                                {url}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                    
                    {quiz.resources.youtube_videos?.length > 0 && (
                      <div>
                        <p className="font-medium text-gray-700 mb-2">Videos:</p>
                        <ul className="space-y-2">
                          {quiz.resources.youtube_videos.map((url, i) => (
                            <li key={i}>
                              <a
                                href={url}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="text-indigo-600 hover:underline text-sm break-all"
                              >
                                {url}
                              </a>
                            </li>
                          ))}
                        </ul>
                      </div>
                    )}
                  </div>
                )}

                <button
                  onClick={() => setStep('quiz')}
                  className="w-full bg-indigo-600 text-white py-4 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2"
                >
                  Start Quiz
                  <ChevronRight />
                </button>
              </div>
            </div>
          </div>
        );
      }

      if (step === 'quiz' && results) {
        const quiz = results.recommended_quizzes[currentQuizIndex];
        const questions = quiz.selected_quiz?.questions || [];
        const score = calculateScore();

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
            <div className="max-w-4xl mx-auto">
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="flex items-center justify-between mb-6">
                  <h1 className="text-3xl font-bold text-gray-800">
                    {quiz.course_name} Quiz
                  </h1>
                  {quizSubmitted && (
                    <div className="text-right">
                      <p className="text-2xl font-bold text-indigo-600">
                        {score.correct} / {score.total}
                      </p>
                      <p className="text-sm text-gray-600">
                        {Math.round((score.correct / score.total) * 100)}% Score
                      </p>
                    </div>
                  )}
                </div>

                <div className="space-y-8">
                  {questions.map((q, qIdx) => {
                    const key = `${currentQuizIndex}-${qIdx}`;
                    const selectedAnswer = userAnswers[key];
                    const isCorrect = selectedAnswer === q.correct_answer;

                    return (
                      <div key={qIdx} className="border border-gray-200 rounded-lg p-6 bg-gray-50">
                        <p className="font-semibold text-lg text-gray-800 mb-4">
                          {qIdx + 1}. {q.question}
                        </p>

                        <div className="space-y-3 mb-4">
                          {q.options?.map((option, oIdx) => {
                            const isSelected = selectedAnswer === option;
                            const isCorrectAnswer = option === q.correct_answer;
                            
                            let bgColor = 'bg-white hover:bg-gray-50';
                            let borderColor = 'border-gray-300';
                            
                            if (quizSubmitted) {
                              if (isCorrectAnswer) {
                                bgColor = 'bg-green-50';
                                borderColor = 'border-green-400';
                              } else if (isSelected && !isCorrect) {
                                bgColor = 'bg-red-50';
                                borderColor = 'border-red-400';
                              }
                            } else if (isSelected) {
                              bgColor = 'bg-indigo-50';
                              borderColor = 'border-indigo-400';
                            }

                            return (
                              <button
                                key={oIdx}
                                onClick={() => !quizSubmitted && handleAnswerSelect(qIdx, option)}
                                disabled={quizSubmitted}
                                className={`w-full text-left p-4 rounded-lg border-2 transition ${bgColor} ${borderColor} ${
                                  !quizSubmitted ? 'cursor-pointer' : 'cursor-default'
                                }`}
                              >
                                <div className="flex items-center gap-3">
                                  {quizSubmitted && isCorrectAnswer && <CheckCircle />}
                                  {quizSubmitted && isSelected && !isCorrect && <XCircle />}
                                  <span className={`${
                                    quizSubmitted && isCorrectAnswer ? 'font-semibold text-green-800' : 
                                    quizSubmitted && isSelected && !isCorrect ? 'text-red-800' : 
                                    'text-gray-800'
                                  }`}>
                                    {option}
                                  </span>
                                </div>
                              </button>
                            );
                          })}
                        </div>

                        {quizSubmitted && q.justification && (
                          <div className="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
                            <p className="text-sm text-gray-700">
                              <strong className="text-blue-800">Explanation:</strong> {q.justification}
                            </p>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                <div className="mt-8 flex gap-4">
                  {!quizSubmitted ? (
                    <button
                      onClick={handleQuizSubmit}
                      disabled={Object.keys(userAnswers).filter(k => k.startsWith(`${currentQuizIndex}-`)).length !== questions.length}
                      className="flex-1 bg-indigo-600 text-white py-4 rounded-lg font-semibold hover:bg-indigo-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
                    >
                      Submit Quiz
                    </button>
                  ) : (
                    <button
                      onClick={goToNextQuiz}
                      className="flex-1 bg-indigo-600 text-white py-4 rounded-lg font-semibold hover:bg-indigo-700 transition flex items-center justify-center gap-2"
                    >
                      {currentQuizIndex < results.recommended_quizzes.length - 1 ? 'Next Quiz' : 'View Summary'}
                      <ChevronRight />
                    </button>
                  )}
                </div>
              </div>
            </div>
          </div>
        );
      }

      if (step === 'summary' && results) {
        const totalQuestions = results.recommended_quizzes.reduce((sum, quiz) => {
          return sum + (quiz.selected_quiz?.questions?.length || 0);
        }, 0);
        
        const totalCorrect = Object.values(allQuizScores).reduce((sum, score) => {
          return sum + score.correct;
        }, 0);
        
        const overallPercentage = Math.round((totalCorrect / totalQuestions) * 100);

        return (
          <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-8">
            <div className="max-w-5xl mx-auto">
              <div className="bg-white rounded-2xl shadow-xl p-8">
                <div className="text-center mb-8">
                  <div className="inline-flex items-center justify-center w-20 h-20 bg-indigo-100 rounded-full mb-4">
                    <svg className="w-12 h-12 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 12l2 2 4-4M7.835 4.697a3.42 3.42 0 001.946-.806 3.42 3.42 0 014.438 0 3.42 3.42 0 001.946.806 3.42 3.42 0 013.138 3.138 3.42 3.42 0 00.806 1.946 3.42 3.42 0 010 4.438 3.42 3.42 0 00-.806 1.946 3.42 3.42 0 01-3.138 3.138 3.42 3.42 0 00-1.946.806 3.42 3.42 0 01-4.438 0 3.42 3.42 0 00-1.946-.806 3.42 3.42 0 01-3.138-3.138 3.42 3.42 0 00-.806-1.946 3.42 3.42 0 010-4.438 3.42 3.42 0 00.806-1.946 3.42 3.42 0 013.138-3.138z" />
                    </svg>
                  </div>
                  <h1 className="text-4xl font-bold text-gray-800 mb-2">Quiz Complete!</h1>
                  <p className="text-gray-600 mb-6">Student ID: <strong>{results.learner_id}</strong></p>
                  
                  <div className="inline-block bg-gradient-to-r from-indigo-500 to-purple-600 rounded-2xl p-8 text-white">
                    <p className="text-lg mb-2">Overall Score</p>
                    <p className="text-6xl font-bold mb-2">{overallPercentage}%</p>
                    <p className="text-lg">{totalCorrect} out of {totalQuestions} correct</p>
                  </div>
                </div>

                <div className="space-y-6 mb-8">
                  {results.recommended_quizzes.map((quiz, idx) => {
                    const score = allQuizScores[quiz.course_name] || { correct: 0, total: 0 };
                    const percentage = score.total > 0 ? Math.round((score.correct / score.total) * 100) : 0;
                    const explanation = results.explanations?.find(e => e.course_name === quiz.course_name);
                    
                    let scoreColor = 'text-red-600';
                    let bgColor = 'bg-red-50';
                    let borderColor = 'border-red-200';
                    
                    if (percentage >= 80) {
                      scoreColor = 'text-green-600';
                      bgColor = 'bg-green-50';
                      borderColor = 'border-green-200';
                    } else if (percentage >= 60) {
                      scoreColor = 'text-yellow-600';
                      bgColor = 'bg-yellow-50';
                      borderColor = 'border-yellow-200';
                    }

                    return (
                      <div key={idx} className={`border-2 ${borderColor} rounded-xl p-6 ${bgColor}`}>
                        <div className="flex items-center justify-between mb-4">
                          <div className="flex items-center gap-3">
                            <BookOpen />
                            <h2 className="text-2xl font-bold text-gray-800">{quiz.course_name}</h2>
                          </div>
                          <div className="text-right">
                            <p className={`text-3xl font-bold ${scoreColor}`}>{percentage}%</p>
                            <p className="text-sm text-gray-600">
                              {score.correct} / {score.total} correct
                            </p>
                          </div>
                        </div>

                        {explanation && (
                          <div className="bg-white rounded-lg p-4 mb-4 border border-gray-200">
                            <p className="text-gray-700 mb-2">
                              <strong className="text-indigo-600">Why this quiz:</strong> {explanation.explanation}
                            </p>
                            <p className="text-gray-600 text-sm">
                              ðŸ’¡ <strong>Tip:</strong> <em>{explanation.learning_tip}</em>
                            </p>
                          </div>
                        )}

                        {quiz.resources && (quiz.resources.websites?.length > 0 || quiz.resources.youtube_videos?.length > 0) && (
                          <div className="bg-white rounded-lg p-4 border border-gray-200">
                            <h3 className="font-semibold text-gray-800 mb-3">ðŸ“š Resources to Improve</h3>
                            
                            {quiz.resources.websites?.length > 0 && (
                              <div className="mb-3">
                                <p className="text-sm font-medium text-gray-700 mb-2">Websites:</p>
                                <ul className="space-y-1">
                                  {quiz.resources.websites.map((url, i) => (
                                    <li key={i}>
                                      <a
                                        href={url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-indigo-600 hover:underline text-sm break-all"
                                      >
                                        {url}
                                      </a>
                                    </li>
                                  ))}
                                </ul>
                              </div>
                            )}
                            
                            {quiz.resources.youtube_videos?.length > 0 && (
                              <div>
                                <p className="text-sm font-medium text-gray-700 mb-2">Videos:</p>
                                <ul className="space-y-1">
                                  {quiz.resources.youtube_videos.map((url, i) => (
                                    <li key={i}>
                                      <a
                                        href={url}
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        className="text-indigo-600 hover:underline text-sm break-all"
                                      >
                                        {url}
                                      </a>
                                    </li>
                                  ))}
                                </ul>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>

                <button
                  onClick={restartFlow}
                  className="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white py-4 rounded-lg font-semibold hover:from-indigo-700 hover:to-purple-700 transition"
                >
                  Start New Session
                </button>
              </div>
            </div>
          </div>
        );
      }

      return null;
    }

    ReactDOM.render(<ELearningApp />, document.getElementById('root'));
  </script>
</body>
</html>